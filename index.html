<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse Skill Planner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Variables for new theme based on screenshot */
        :root {
            --bg-color: #1a1a1a; /* Very dark grey / black */
            --primary-accent: #ffd700; /* Gold */
            --secondary-accent: #ffe55c; /* Lighter gold */
            --text-color: #f0f0f0; /* Light grey / white */
            --text-color-dark: #333333; /* For elements on light backgrounds */
            --card-bg: #2c2c2c; /* Dark grey for cards/sections */
            --border-color: #444444; /* Subtle borders */
            --progress-bar-bg: #555555;
            --progress-bar-fill: var(--primary-accent);
            --button-reset-bg: #4a4a4a;
            --border-radius: 8px;
            --transition-speed: 0.3s;
            --ring-inactive-color: var(--border-color);
            --ring-active-color: var(--primary-accent);
            --ring-outer-radius: 35px;
            --ring-inner-radius: 25px;
            --ring-thickness: calc(var(--ring-outer-radius) - var(--ring-inner-radius));
            --ring-gap: 2px; /* Gap between segments */
            --modal-bg: #222222;
            --overlay-bg: rgba(0,0,0,0.7);
            --input-bg: #333333;
            --delete-color: #ff6b6b;
            --toast-bg: rgba(0,0,0,0.85);
            --toast-success: #4caf50;
            --toast-info: #2196f3;
            --toast-warning: #ff9800;
            --toast-error: #f44336;
            --sticky-bg: rgba(26, 26, 26, 0.95); /* Slightly transparent background for sticky header */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 95%;
            max-width: 900px; /* Adjusted max-width */
            text-align: center;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            color: var(--primary-accent);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-size: 2em;
            margin: 0;
        }
        
        .horse-info-area {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding: 15px;
            background-color: rgba(0,0,0,0.1);
            border-radius: var(--border-radius);
        }

        .horse-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-accent); /* Placeholder */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* For actual image */
        }
        .horse-avatar i { /* For Font Awesome icon as placeholder */
            font-size: 30px;
            color: var(--bg-color);
        }

        .horse-name {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-color);
        }

        .reset-horse-button {
            background-color: var(--button-reset-bg);
            color: var(--text-color);
            border: 1px solid var(--primary-accent);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9em;
            margin-left: auto; /* Pushes button to the right */
            transition: background-color var(--transition-speed);
        }
        .reset-horse-button:hover {
            background-color: var(--primary-accent);
            color: var(--text-color-dark);
        }

        .points-summary-container {
            position: relative;
            height: auto;
            margin-bottom: 30px;
        }

        .points-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--sticky-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: box-shadow 0.3s ease;
        }
        
        /* JS will add this class when the element is sticky */
        .points-summary-grid.is-sticky {
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .skill-points-bar-container {
            background-color: var(--progress-bar-bg);
            border-radius: var(--border-radius);
            padding: 5px;
            height: 30px; /* Total height including padding */
            display: flex;
            align-items: center;
            position: relative;
        }
        #skillPointsBar {
            height: 100%;
            background-color: var(--progress-bar-fill);
            border-radius: calc(var(--border-radius) - 3px);
            transition: width var(--transition-speed) ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .skill-points-text-overlay {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-weight: bold;
            color: var(--text-color);
            font-size: 0.9em;
            pointer-events: none; /* Allows clicks to pass through if needed */
            background-color: rgba(0, 0, 0, 0.5);
            padding: 2px 12px;
            border-radius: 4px;
            backdrop-filter: blur(1px);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.25);
        }


        .unallocated-points-display {
            background-color: transparent;
            padding: 10px 15px;
            border: 1px solid var(--primary-accent);
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: bold;
        }
        .max-points-control-group {
            display: flex;
            flex-direction: row; /* Change to row for single line layout */
            align-items: center;
            gap: 8px;
            padding: 10px 15px; /* Match padding with unallocated-points-display */
            border: 1px solid var(--primary-accent); /* Match border with unallocated-points-display */
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
        }
        .max-points-control-group label {
            font-size: 0.9em;
            color: var(--secondary-accent);
            margin-right: 2px;
        }
        .max-points-control-group input[type="number"] {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px;
            width: 60px;
            text-align: center;
            font-size: 1em;
        }
        /* Hide spinner buttons for number input */
        .max-points-control-group input[type=number]::-webkit-inner-spin-button, 
        .max-points-control-group input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        .max-points-control-group input[type=number] {
          -moz-appearance: textfield; /* Firefox */
        }

        .max-points-display {
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: var(--border-radius);
            transition: background-color var(--transition-speed);
        }
        
        .max-points-display:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .max-points-display .edit-icon {
            color: var(--border-color);
            font-size: 0.9em;
            opacity: 0.6;
            transition: opacity var(--transition-speed), color var(--transition-speed);
        }
        
        .max-points-display:hover .edit-icon {
            opacity: 1;
            color: var(--primary-accent);
        }
        
        .max-points-editor {
            display: none;
            align-items: center;
            gap: 4px;
            vertical-align: middle;
        }
        
        .max-points-editor input {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 2px 5px;
            font-size: 0.95em;
            width: 60px;
            text-align: center;
        }
        
        .max-points-editor button {
            background-color: transparent;
            border: none;
            color: var(--border-color);
            cursor: pointer;
            transition: color var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }
        
        .max-points-editor button:hover {
            color: var(--primary-accent);
        }

        .max-points-editor button.confirm {
            color: var(--secondary-accent);
        }

        .skill-category-section {
            margin-bottom: 30px;
        }

        .skill-category-section h2 {
            color: var(--primary-accent);
            text-align: left;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Responsive grid */
            gap: 20px;
            justify-items: center;
        }

        .skill-item-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background-color: rgba(0,0,0,0.1); /* Slightly darker than card-bg */
            border-radius: var(--border-radius);
            width: 110px; /* Fixed width for consistency */
        }

        .skill-visual-area {
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .skill-level-ring-svg {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .ring-segment {
            fill: var(--ring-inactive-color);
            transition: fill var(--transition-speed);
            stroke: rgba(0, 0, 0, 0.3);
            stroke-width: var(--ring-gap);
        }
        
        .ring-segment.active {
            fill: var(--ring-active-color);
        }

        .skill-main-circle {
            position: absolute;
            z-index: 2;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--card-bg);
            border: 3px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: border-color var(--transition-speed);
            cursor: default; /* Will use buttons for interaction */
        }
        .skill-main-circle i { /* Skill icon */
            font-size: 24px;
            color: var(--border-color); /* Default icon color */
            transition: color var(--transition-speed);
        }

        .skill-item-card.active .skill-main-circle {
            border-color: var(--primary-accent);
        }
        .skill-item-card.active .skill-main-circle i {
            color: var(--primary-accent); /* Active icon color */
        }

        .skill-name-text {
            font-size: 0.85em;
            margin-bottom: 10px;
            min-height: 2.5em; /* Ensure space for two lines of text */
            text-align: center;
        }

        .skill-action-buttons {
            display: flex;
            gap: 8px;
        }
        .skill-action-buttons button {
            background-color: var(--card-bg);
            color: var(--primary-accent);
            border: 1px solid var(--primary-accent);
            border-radius: 50%; /* Circular buttons */
            width: 30px;
            height: 30px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .skill-action-buttons button:hover:not(:disabled) {
            background-color: var(--primary-accent);
            color: var(--text-color-dark);
        }
        .skill-action-buttons button:disabled {
            border-color: var(--border-color);
            color: var(--border-color);
            cursor: not-allowed;
        }
        
        .skill-cost-info-text { /* This class was in old HTML, not used in screenshot style */
            display: none; /* Hidden for this design, functionality remains in JS */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Reduced padding */
            }
            .container {
                padding: 15px; /* Reduced padding */
            }
            header h1 {
                font-size: 1.6em; /* Slightly reduced */
            }
            .horse-info-area {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px; /* Reduced gap */
                padding: 10px; /* Reduced padding */
                margin-bottom: 20px; /* Reduced margin */
            }
            .horse-avatar {
                width: 50px; /* Smaller avatar */
                height: 50px;
            }
            .horse-avatar i {
                font-size: 25px; /* Smaller icon in avatar */
            }
            .horse-name {
                font-size: 1.3em; /* Slightly reduced */
            }
            .reset-horse-button {
                margin-left: 0;
                margin-top: 8px; /* Reduced margin */
                padding: 6px 12px; /* Smaller button */
                font-size: 0.85em;
            }
            .points-summary-grid {
                grid-template-columns: 1fr; /* Stack point displays */
                gap: 10px; /* Reduced gap */
                margin-bottom: 20px; /* Reduced margin */
            }
            .unallocated-points-display, .max-points-control-group {
                padding: 8px 12px; /* Reduced padding */
                font-size: 0.85em;
            }
            .max-points-control-group input[type="number"] {
                padding: 4px;
                width: 50px;
                font-size: 0.9em;
            }
            .skill-category-section {
                margin-bottom: 20px; /* Reduced margin */
            }
            .skill-category-section h2 {
                font-size: 1.1em; /* Reduced font size */
                margin-bottom: 10px; /* Reduced margin */
            }
            .skills-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); /* Smaller minmax */
                gap: 10px; /* Reduced gap */
            }
            .skill-item-card {
                width: 90px; /* Reduced width */
                padding: 8px; /* Reduced padding */
            }
            .skill-visual-area {
                width: 70px;
                height: 70px;
            }
            .skill-main-circle {
                width: 40px; /* Smaller circle */
                height: 40px;
            }
            .skill-main-circle i {
                font-size: 18px; /* Smaller icon */
            }
            .skill-name-text {
                font-size: 0.8em; /* Reduced font size */
                margin-bottom: 8px; /* Reduced margin */
                min-height: 2.2em; /* Adjusted min-height */
            }
            .skill-action-buttons button {
                width: 25px; /* Smaller buttons */
                height: 25px;
                font-size: 0.9em;
            }
            :root {
                --ring-outer-radius: 30px;
                --ring-inner-radius: 22px;
            }
        }
         @media (max-width: 480px) {
            body { padding: 5px; } /* Further reduced */
            .container { padding: 10px; } /* Further reduced */
            header {
                margin-bottom: 15px; /* Reduced margin */
                padding-bottom: 10px; /* Reduced padding */
            }
            header h1 {
                font-size: 1.3em; /* Further reduced */
            }
            .horse-info-area {
                margin-bottom: 15px; /* Further reduced */
            }
             .points-summary-grid {
                margin-bottom: 15px; /* Further reduced */
            }
            .skill-points-bar-container {
                height: 25px; /* Reduced height */
            }
            .skill-points-text-overlay {
                font-size: 0.8em;
            }
            .skills-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* More dense: allow more columns if space */
                gap: 8px; /* Further reduced gap */
            }
             .skill-item-card {
                padding: 6px; /* Further reduced padding */
                width: auto; /* Allow to fill based on grid */
            }
            .skill-visual-area {
                width: 60px;
                height: 60px;
            }
            .skill-main-circle {
                width: 36px; /* Further reduced */
                height: 36px;
                border-width: 2px;
            }
            .skill-main-circle i {
                font-size: 16px; /* Further reduced */
            }
            .skill-name-text {
                font-size: 0.75em; /* Further reduced */
                min-height: 2em; /* Adjusted for smaller font */
            }
            .skill-action-buttons button {
                width: 22px; /* Further reduced */
                height: 22px;
                font-size: 0.8em;
            }
            :root {
                --ring-outer-radius: 25px;
                --ring-inner-radius: 18px;
            }
        }

        .horse-management-buttons {
            display: flex;
            gap: 8px;
        }

        .horse-menu-button {
            background-color: var(--card-bg);
            color: var(--primary-accent);
            border: 1px solid var(--primary-accent);
            border-radius: var(--border-radius);
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .horse-menu-button:hover {
            background-color: var(--primary-accent);
            color: var(--text-color-dark);
        }

        .horse-name-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-name-button {
            background-color: transparent;
            border: none;
            color: var(--border-color);
            cursor: pointer;
            font-size: 0.9em;
            transition: color var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .edit-name-button:hover {
            color: var(--primary-accent);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-bg);
            z-index: 1000;
            overflow: auto;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--modal-bg);
            margin: auto;
            padding: 20px;
            border: 1px solid var(--primary-accent);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .close-modal {
            color: var(--border-color);
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: color var(--transition-speed);
        }

        .close-modal:hover {
            color: var(--primary-accent);
        }

        .modal h2 {
            color: var(--primary-accent);
            margin-top: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Horse list styles */
        .horse-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .horse-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: border-color var(--transition-speed);
        }

        .horse-list-item:hover {
            border-color: var(--primary-accent);
        }

        .horse-list-item-name {
            font-weight: bold;
            color: var(--text-color);
        }

        .horse-list-actions {
            display: flex;
            gap: 8px;
        }

        .horse-list-button {
            background-color: transparent;
            border: none;
            color: var(--border-color);
            cursor: pointer;
            transition: color var(--transition-speed);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .horse-list-button:hover {
            color: var(--primary-accent);
        }

        .horse-list-button.delete:hover {
            color: var(--delete-color);
        }

        /* Form styles */
        .horse-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 0.9em;
            color: var(--secondary-accent);
        }

        .form-group input {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            font-size: 1em;
            transition: border-color var(--transition-speed);
        }

        .form-group input:focus {
            border-color: var(--primary-accent);
            outline: none;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .form-button {
            background-color: var(--button-reset-bg);
            color: var(--text-color);
            border: 1px solid var(--primary-accent);
            border-radius: var(--border-radius);
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .form-button:hover {
            background-color: var(--primary-accent);
            color: var(--text-color-dark);
        }

        .form-button.cancel {
            border-color: var(--border-color);
        }

        .form-button.cancel:hover {
            background-color: var(--border-color);
        }

        .empty-state {
            text-align: center;
            padding: 20px 0;
            color: var(--border-color);
        }

        /* Name editor */
        .inline-name-editor {
            display: none;
            align-items: center;
            gap: 8px;
        }

        .inline-name-editor input {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 5px 10px;
            font-size: 1em;
            width: 150px;
        }

        .inline-name-editor button {
            background-color: transparent;
            border: none;
            color: var(--border-color);
            cursor: pointer;
            transition: color var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .inline-name-editor button:hover {
            color: var(--primary-accent);
        }

        .inline-name-editor button.confirm {
            color: var(--secondary-accent);
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            max-width: 350px;
        }

        .toast {
            background-color: var(--toast-bg);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateX(100%);
            opacity: 0;
            border-left: 3px solid var(--primary-accent);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            flex-shrink: 0;
            font-size: 1.2em;
        }

        .toast-icon.success {
            color: var(--toast-success);
        }

        .toast-icon.primary {
            color: var(--primary-accent);
        }

        .toast-icon.info {
            color: var(--toast-info);
        }

        .toast-icon.warning {
            color: var(--toast-warning);
        }

        .toast-icon.error {
            color: var(--toast-error);
        }

        .toast.success {
            border-left-color: var(--toast-success);
        }
        
        .toast.info {
            border-left-color: var(--toast-info);
        }
        
        .toast.warning {
            border-left-color: var(--toast-warning);
        }
        
        .toast.error {
            border-left-color: var(--toast-error);
        }

        .toast-content {
            flex-grow: 1;
        }

        .toast-message {
            margin: 0;
        }

        /* Welcome Popup for First-Time Visitors */
        .welcome-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-bg);
            z-index: 1000;
            overflow: auto;
            justify-content: center;
            align-items: center;
        }

        .welcome-content {
            background-color: var(--modal-bg);
            margin: auto;
            padding: 20px;
            border: 1px solid var(--primary-accent);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .welcome-body {
            text-align: left;
            margin-bottom: 20px;
        }

        .welcome-tips {
            margin-bottom: 20px;
        }

        .welcome-tips h3 {
            color: var(--primary-accent);
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .welcome-tips ul {
            list-style-type: disc;
            padding-left: 20px;
        }

        .welcome-cta-button {
            background-color: var(--primary-accent);
            color: var(--text-color-dark);
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }

        .welcome-cta-button:hover {
            background-color: var(--secondary-accent);
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>HORSE SKILLS</h1>
            <div class="horse-management-buttons">
                <button id="newHorseBtn" class="horse-menu-button"><i class="fas fa-plus"></i> New</button>
                <button id="saveHorseBtn" class="horse-menu-button"><i class="fas fa-save"></i> Save</button>
                <button id="loadHorseBtn" class="horse-menu-button"><i class="fas fa-folder-open"></i> Load</button>
            </div>
        </header>

        <section class="horse-info-area">
            <div class="horse-avatar"><i class="fas fa-horse-head"></i></div>
            <div class="horse-name-container">
                <span class="horse-name" id="horseName">New Horse</span>
                <button id="editNameBtn" class="edit-name-button"><i class="fas fa-pencil-alt"></i></button>
            </div>
            <button id="resetHorseBtn" class="reset-horse-button">RESET SKILLS</button>
        </section>

        <section class="points-summary-container">
            <div class="points-summary-grid">
                <div class="skill-points-bar-container">
                    <div id="skillPointsBar"></div>
                    <span id="skillPointsText" class="skill-points-text-overlay">Skill Points: 0/100</span>
                </div>
                <div id="unallocatedPointsDisplay" class="unallocated-points-display">
                    Unallocated points: 100
                </div>
                <div class="max-points-control-group">
                    Max Points: 
                    <div id="maxPointsDisplay" class="max-points-display">
                        <span id="maxPointsValue">100</span>
                        <i class="fas fa-pencil-alt edit-icon"></i>
                    </div>
                    <div id="maxPointsEditor" class="max-points-editor">
                        <input type="number" id="maxSkillPointsInput" value="100" min="0">
                        <button id="confirmMaxPoints" class="confirm" title="Confirm"><i class="fas fa-check"></i></button>
                        <button id="cancelMaxPoints" title="Cancel"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <section class="skill-category-section" id="starting-skills-category">
            <h2>STARTING SKILLS</h2>
            <div class="skills-grid">
                </div>
        </section>

        <section class="skill-category-section" id="racing-skills-category">
            <h2>RACING SKILLS</h2>
            <div class="skills-grid">
                </div>
        </section>

        <section class="skill-category-section" id="finishing-skills-category">
            <h2>FINISHING SKILLS</h2>
            <div class="skills-grid">
                </div>
        </section>

        <!-- Horse management modal -->
        <div id="horseManagementModal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 id="modalTitle">Load Horse</h2>
                <div id="modalContent">
                    <!-- Content will be dynamically inserted based on action -->
                </div>
            </div>
        </div>

        <!-- Toast notifications container -->
        <div class="toast-container" id="toastContainer">
            <!-- Toasts will be dynamically inserted here -->
        </div>
        
        <!-- Welcome Popup for First-Time Visitors -->
        <div id="welcomePopup" class="modal welcome-popup">
            <div class="modal-content welcome-content">
                <span class="close-modal" id="closeWelcomePopup">&times;</span>
                <h2>Welcome to Horse Skill Planner!</h2>
                <div class="welcome-body">
                    <p>This tool helps you plan and optimize your Owner's Club horse skills by calculating the cost of each skill level like the in-game skills.</p>
                    
                    <div class="welcome-tips">
                        <h3>Quick Tips:</h3>
                        <ul>
                            <li><i class="fas fa-plus-circle"></i> Add and remove levels to different skills using the plus and minus buttons</li>
                            <li><i class="fas fa-save"></i> Add and save multiple horses to keep track of different horses or different builds</li>
                            <li><i class="fas fa-sliders-h"></i> Customize max skill points for different competition levels</li>
                            <li><i class="fas fa-info-circle"></i> All horses are saved locally on your device and browser only</li>
                        </ul>
                    </div>
                    
                    <button id="welcomeGetStartedBtn" class="welcome-cta-button">
                        <i class="fas fa-horse"></i> Get Started with a New Horse
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SKILL DATA AND CONFIGURATION ---
        const skillsConfiguration = {
            // Icons from Font Awesome (example selection)
            starting: [
                { id: 'firstOut', name: 'First Out', currentLevel: 0, maxLevel: 5, icon: 'fas fa-rocket' },
                { id: 'toTheFront', name: 'To the Front', currentLevel: 0, maxLevel: 5, icon: 'fas fa-angle-double-up' },
                { id: 'toTheRail', name: 'To the Rail', currentLevel: 0, maxLevel: 5, icon: 'fas fa-compress-arrows-alt' },
            ],
            racing: [
                { id: 'breezing', name: 'Breezing', currentLevel: 0, maxLevel: 5, icon: 'fas fa-wind' },
                { id: 'working', name: 'Working', currentLevel: 0, maxLevel: 5, icon: 'fas fa-cogs' }, // Changed from cog to cogs
                { id: 'drafting', name: 'Drafting', currentLevel: 0, maxLevel: 5, icon: 'fas fa-users' },
                { id: 'leadLegChange', name: 'Lead Leg Change', currentLevel: 0, maxLevel: 5, icon: 'fas fa-exchange-alt' },
            ],
            finishing: [
                { id: 'dueling', name: 'Dueling', currentLevel: 0, maxLevel: 5, icon: 'fas fa-fist-raised' }, // Using 'fist-raised' in Free version
                { id: 'overtaking', name: 'Overtaking', currentLevel: 0, maxLevel: 5, icon: 'fas fa-angle-double-right' },
                { id: 'finalKick', name: 'Final Kick', currentLevel: 0, maxLevel: 5, icon: 'fas fa-bolt' },
                { id: 'closing', name: 'Closing', currentLevel: 0, maxLevel: 5, icon: 'fas fa-flag-checkered' },
            ]
        };

        const pointsCostPerLevelIncrement = [1, 2, 5, 7, 10];
        const cumulativePointsCostForLevel = [0];
        let currentCumulativeCost = 0;
        for (const cost of pointsCostPerLevelIncrement) {
            currentCumulativeCost += cost;
            cumulativePointsCostForLevel.push(currentCumulativeCost);
        }

        let currentMaxSkillPoints = 100;
        let currentUsedSkillPoints = 0;
        let currentHorseName = "New Horse";
        let currentHorseId = null;

        // DOM Elements
        const maxSkillPointsInputElement = document.getElementById('maxSkillPointsInput');
        const maxPointsDisplayElement = document.getElementById('maxPointsDisplay');
        const maxPointsValueElement = document.getElementById('maxPointsValue');
        const maxPointsEditorElement = document.getElementById('maxPointsEditor');
        const confirmMaxPointsButton = document.getElementById('confirmMaxPoints');
        const cancelMaxPointsButton = document.getElementById('cancelMaxPoints');
        const skillPointsTextElement = document.getElementById('skillPointsText');
        const skillPointsBarElement = document.getElementById('skillPointsBar');
        const unallocatedPointsDisplayElement = document.getElementById('unallocatedPointsDisplay');
        const resetHorseButton = document.getElementById('resetHorseBtn');
        const horseNameElement = document.getElementById('horseName');
        const editNameButton = document.getElementById('editNameBtn');
        const newHorseButton = document.getElementById('newHorseBtn');
        const saveHorseButton = document.getElementById('saveHorseBtn');
        const loadHorseButton = document.getElementById('loadHorseBtn');
        const horseManagementModal = document.getElementById('horseManagementModal');
        const closeModalButton = document.querySelector('.close-modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const toastContainer = document.getElementById('toastContainer');

        // ------ TOAST NOTIFICATION FUNCTIONS ------
        
        /**
         * Show a toast notification
         * @param {string} message - The message to display
         * @param {string} type - The type of toast ('success', 'error', 'info', 'warning')
         * @param {number} duration - Duration in milliseconds to show the toast
         */
        function showToast(message, type = 'info', duration = 3000) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Select icon based on type
            let icon = 'fas fa-info-circle';
            let iconClass = 'info';
            
            if (type === 'success') {
                icon = 'fas fa-check-circle';
                iconClass = 'success';
            } else if (type === 'error') {
                icon = 'fas fa-exclamation-circle';
                iconClass = 'error';
            } else if (type === 'warning') {
                icon = 'fas fa-exclamation-triangle';
                iconClass = 'warning';
            } else if (type === 'primary') {
                icon = 'fas fa-star';
                iconClass = 'primary';
            }
            
            // Set toast content
            toast.innerHTML = `
                <div class="toast-icon ${iconClass}">
                    <i class="${icon}"></i>
                </div>
                <div class="toast-content">
                    <p class="toast-message">${message}</p>
                </div>
            `;
            
            // Add to container
            toastContainer.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Set timeout to remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                
                // Remove from DOM after animation completes
                setTimeout(() => {
                    if (toast.parentNode === toastContainer) {
                        toastContainer.removeChild(toast);
                    }
                }, 300);
            }, duration);
            
            // Return the toast element in case we need to reference it
            return toast;
        }

        // ------ HORSE MANAGEMENT FUNCTIONS ------
        
        // Local Storage Key
        const HORSES_STORAGE_KEY = 'savedHorses';
        const LAST_LOADED_HORSE_KEY = 'lastLoadedHorseId';
        
        // Get all saved horses from local storage
        function getSavedHorses() {
            const savedHorsesJson = localStorage.getItem(HORSES_STORAGE_KEY);
            return savedHorsesJson ? JSON.parse(savedHorsesJson) : {};
        }
        
        // Save horses to local storage
        function saveHorsesToStorage(horses) {
            localStorage.setItem(HORSES_STORAGE_KEY, JSON.stringify(horses));
        }
        
        // Save the current horse ID as the last loaded horse
        function saveLastLoadedHorseId(horseId) {
            localStorage.setItem(LAST_LOADED_HORSE_KEY, horseId);
        }
        
        // Get the last loaded horse ID
        function getLastLoadedHorseId() {
            return localStorage.getItem(LAST_LOADED_HORSE_KEY);
        }
        
        // Create a new unique ID for a horse
        function generateHorseId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }
        
        // Get the current horse state
        function getCurrentHorseState() {
            const skillData = {};
            
            for (const category in skillsConfiguration) {
                skillData[category] = skillsConfiguration[category].map(skill => ({
                    id: skill.id,
                    currentLevel: skill.currentLevel
                }));
            }
            
            return {
                id: currentHorseId || generateHorseId(),
                name: currentHorseName,
                maxSkillPoints: currentMaxSkillPoints,
                skills: skillData,
                lastModified: new Date().toISOString()
            };
        }
        
        // Load a horse state
        function loadHorseState(horseState) {
            // Set basic properties
            currentHorseId = horseState.id;
            currentHorseName = horseState.name;
            currentMaxSkillPoints = horseState.maxSkillPoints || 100;
            
            // Update UI
            horseNameElement.textContent = currentHorseName;
            maxSkillPointsInputElement.value = currentMaxSkillPoints;
            maxPointsValueElement.textContent = currentMaxSkillPoints;
            
            // Reset all skills to 0 first
            for (const category in skillsConfiguration) {
                skillsConfiguration[category].forEach(skill => {
                    skill.currentLevel = 0;
                });
            }
            
            // Load skills from saved state
            for (const category in horseState.skills) {
                horseState.skills[category].forEach(savedSkill => {
                    const skill = getSkillObjectById(savedSkill.id);
                    if (skill) {
                        skill.currentLevel = savedSkill.currentLevel;
                    }
                });
            }
            
            // Update all displays
            updateSkillPointSummaryDisplays();
            
            // Re-render all skills
            for (const category in skillsConfiguration) {
                skillsConfiguration[category].forEach(skill => {
                    renderSingleSkill(skill);
                });
            }
            
            // Save this horse as the last loaded horse
            saveLastLoadedHorseId(horseState.id);
            
            // Show toast notification
            showToast(`"${horseState.name}" loaded successfully!`, 'info');
        }
        
        // Create a new horse
        function createNewHorse(name = "New Horse") {
            // Reset all skills to 0
            for (const category in skillsConfiguration) {
                skillsConfiguration[category].forEach(skill => {
                    skill.currentLevel = 0;
                });
            }
            
            // Set new horse properties
            currentHorseId = generateHorseId();
            currentHorseName = name;
            currentMaxSkillPoints = 100;
            
            // Update UI
            horseNameElement.textContent = currentHorseName;
            maxSkillPointsInputElement.value = currentMaxSkillPoints;
            
            // Update displays
            updateSkillPointSummaryDisplays();
            
            // Re-render all skills
            for (const category in skillsConfiguration) {
                skillsConfiguration[category].forEach(skill => {
                    renderSingleSkill(skill);
                });
            }
            
            // Save as last loaded horse
            saveLastLoadedHorseId(currentHorseId);
            
            // Automatically save the horse to localStorage
            const savedHorse = saveCurrentHorse();
            
            // Show toast notification
            showToast(`New horse "${name}" created and saved!`, 'success');
        }
        
        // Save current horse
        function saveCurrentHorse() {
            const horses = getSavedHorses();
            const currentHorse = getCurrentHorseState();
            
            // Add or update horse in the collection
            horses[currentHorse.id] = currentHorse;
            
            // Save to local storage
            saveHorsesToStorage(horses);
            
            // Update current horse ID
            currentHorseId = currentHorse.id;
            
            // Save as last loaded horse
            saveLastLoadedHorseId(currentHorse.id);
            
            return currentHorse;
        }
        
        // Delete a horse by ID
        function deleteHorse(horseId) {
            const horses = getSavedHorses();
            
            if (horses[horseId]) {
                const horseName = horses[horseId].name;
                delete horses[horseId];
                saveHorsesToStorage(horses);
                
                // Check if this was the last loaded horse
                if (getLastLoadedHorseId() === horseId) {
                    // Clear the last loaded horse reference
                    localStorage.removeItem(LAST_LOADED_HORSE_KEY);
                    
                    // If this was also the current horse, create a new default one
                    if (currentHorseId === horseId) {
                        createNewHorse("New Horse");
                    }
                }
                
                // Show toast notification
                showToast(`"${horseName}" deleted!`, 'warning');
                
                return true;
            }
            
            return false;
        }
        
        // ------ MODAL FUNCTIONS ------
        
        // Open the modal
        function openModal(title) {
            modalTitle.textContent = title;
            horseManagementModal.style.display = 'flex';
        }
        
        // Close the modal
        function closeModal() {
            horseManagementModal.style.display = 'none';
            modalContent.innerHTML = '';
        }
        
        // Load horse list into modal
        function showLoadHorseModal() {
            openModal('Load Horse');
            
            const horses = getSavedHorses();
            const horseIds = Object.keys(horses);
            
            if (horseIds.length === 0) {
                modalContent.innerHTML = `
                    <div class="empty-state">
                        <p>No saved horses found.</p>
                        <p>Create and save a horse first.</p>
                    </div>
                `;
                return;
            }
            
            // Sort horses by last modified date (newest first)
            horseIds.sort((a, b) => {
                const dateA = new Date(horses[a].lastModified || 0);
                const dateB = new Date(horses[b].lastModified || 0);
                return dateB - dateA;
            });
            
            let horseListHTML = '<div class="horse-list">';
            
            horseIds.forEach(horseId => {
                const horse = horses[horseId];
                const formattedDate = new Date(horse.lastModified).toLocaleDateString();
                
                horseListHTML += `
                    <div class="horse-list-item" data-horse-id="${horseId}">
                        <span class="horse-list-item-name">${horse.name}</span>
                        <div class="horse-list-actions">
                            <button class="horse-list-button load" title="Load Horse">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="horse-list-button delete" title="Delete Horse">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            horseListHTML += '</div>';
            modalContent.innerHTML = horseListHTML;
            
            // Add event listeners for action buttons
            const loadButtons = modalContent.querySelectorAll('.horse-list-button.load');
            loadButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const horseId = e.target.closest('.horse-list-item').dataset.horseId;
                    loadHorseState(horses[horseId]);
                    closeModal();
                });
            });
            
            const deleteButtons = modalContent.querySelectorAll('.horse-list-button.delete');
            deleteButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const listItem = e.target.closest('.horse-list-item');
                    const horseId = listItem.dataset.horseId;
                    const horseName = horses[horseId].name;
                    
                    if (confirm(`Are you sure you want to delete "${horseName}"?`)) {
                        deleteHorse(horseId);
                        listItem.remove();
                        
                        // Check if there are no more horses
                        if (modalContent.querySelectorAll('.horse-list-item').length === 0) {
                            modalContent.innerHTML = `
                                <div class="empty-state">
                                    <p>No saved horses found.</p>
                                    <p>Create and save a horse first.</p>
                                </div>
                            `;
                        }
                    }
                });
            });
        }
        
        // Show new horse form
        function showNewHorseModal() {
            openModal('Create New Horse');
            
            modalContent.innerHTML = `
                <div class="horse-form">
                    <div class="form-group">
                        <label for="newHorseName">Horse Name:</label>
                        <input type="text" id="newHorseName" placeholder="Enter horse name" value="New Horse">
                    </div>
                    <div class="form-actions">
                        <button class="form-button cancel">Cancel</button>
                        <button class="form-button create">Create</button>
                    </div>
                </div>
            `;
            
            const cancelButton = modalContent.querySelector('.form-button.cancel');
            cancelButton.addEventListener('click', closeModal);
            
            const createButton = modalContent.querySelector('.form-button.create');
            createButton.addEventListener('click', () => {
                const nameInput = document.getElementById('newHorseName');
                const horseName = nameInput.value.trim() || 'New Horse';
                createNewHorse(horseName);
                closeModal();
            });
            
            // Focus the input field
            setTimeout(() => {
                const nameInput = document.getElementById('newHorseName');
                nameInput.focus();
                nameInput.select();
            }, 100);
        }
        
        // Show save horse modal
        function showSaveHorseModal() {
            // Save the horse immediately without showing modal
            const savedHorse = saveCurrentHorse();
            
            // Show success toast
            showToast(`"${savedHorse.name}" has been saved successfully!`, 'success');
        }
        
        // ------ INLINE NAME EDITING ------
        
        // Create the inline name editor
        function createNameEditor() {
            // Create the inline editor if it doesn't exist
            if (!document.querySelector('.inline-name-editor')) {
                const nameContainer = document.querySelector('.horse-name-container');
                const nameEditorDiv = document.createElement('div');
                nameEditorDiv.className = 'inline-name-editor';
                nameEditorDiv.innerHTML = `
                    <input type="text" id="inlineNameInput">
                    <button class="confirm" title="Confirm"><i class="fas fa-check"></i></button>
                    <button class="cancel" title="Cancel"><i class="fas fa-times"></i></button>
                `;
                nameContainer.appendChild(nameEditorDiv);
                
                // Add event listeners
                const confirmButton = nameEditorDiv.querySelector('button.confirm');
                confirmButton.addEventListener('click', confirmNameEdit);
                
                const cancelButton = nameEditorDiv.querySelector('button.cancel');
                cancelButton.addEventListener('click', cancelNameEdit);
                
                const nameInput = nameEditorDiv.querySelector('#inlineNameInput');
                nameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        confirmNameEdit();
                    } else if (e.key === 'Escape') {
                        cancelNameEdit();
                    }
                });
            }
        }
        
        // Show the inline name editor
        function showNameEditor() {
            createNameEditor();
            
            // Hide the name and edit button, show the editor
            horseNameElement.style.display = 'none';
            editNameButton.style.display = 'none';
            
            const nameEditor = document.querySelector('.inline-name-editor');
            nameEditor.style.display = 'flex';
            
            // Set the current name in the input
            const nameInput = document.getElementById('inlineNameInput');
            nameInput.value = currentHorseName;
            
            // Focus the input
            nameInput.focus();
            nameInput.select();
        }
        
        // Confirm name edit
        function confirmNameEdit() {
            const nameInput = document.getElementById('inlineNameInput');
            const newName = nameInput.value.trim();
            
            if (newName) {
                const oldName = currentHorseName;
                currentHorseName = newName;
                horseNameElement.textContent = newName;
                
                // Show toast if name actually changed
                if (oldName !== newName) {
                    showToast(`Horse renamed to "${newName}"!`, 'info');
                    
                    // Auto-save horse after name change
                    autoSaveHorse();
                }
            }
            
            // Hide editor, show name and button
            document.querySelector('.inline-name-editor').style.display = 'none';
            horseNameElement.style.display = '';
            editNameButton.style.display = '';
        }
        
        // Cancel name edit
        function cancelNameEdit() {
            // Hide editor, show name and button
            document.querySelector('.inline-name-editor').style.display = 'none';
            horseNameElement.style.display = '';
            editNameButton.style.display = '';
        }

        // Rest of existing functions
        function getSkillObjectById(skillId) {
            for (const category in skillsConfiguration) {
                const skill = skillsConfiguration[category].find(s => s.id === skillId);
                if (skill) return skill;
            }
            return null;
        }

        function calculateTotalUsedPoints() {
            let totalPoints = 0;
            for (const category in skillsConfiguration) {
                skillsConfiguration[category].forEach(skill => {
                    totalPoints += cumulativePointsCostForLevel[skill.currentLevel];
                });
            }
            return totalPoints;
        }
        
        function updateSkillPointSummaryDisplays() {
            currentUsedSkillPoints = calculateTotalUsedPoints();
            const availablePoints = currentMaxSkillPoints - currentUsedSkillPoints;

            skillPointsTextElement.textContent = `Skill Points: ${currentUsedSkillPoints}/${currentMaxSkillPoints}`;
            const percentage = currentMaxSkillPoints > 0 ? (currentUsedSkillPoints / currentMaxSkillPoints) * 100 : 0;
            skillPointsBarElement.style.width = `${Math.min(percentage, 100)}%`; // Cap at 100%

            unallocatedPointsDisplayElement.textContent = `Unallocated points: ${availablePoints}`;
            
            if (availablePoints < 0) {
                unallocatedPointsDisplayElement.style.color = '#FF6B6B'; // A light red for dark theme
                skillPointsBarElement.style.backgroundColor = '#FF6B6B'; 
            } else {
                unallocatedPointsDisplayElement.style.color = ''; // Reset to default
                skillPointsBarElement.style.backgroundColor = ''; // Reset to default
            }
            updateAllSkillActionButtonsState();
        }

        function getCostForNextSkillLevel(skill) {
            if (skill.currentLevel >= skill.maxLevel) return Infinity;
            return pointsCostPerLevelIncrement[skill.currentLevel];
        }

        function renderSingleSkill(skill) {
            const skillElement = document.getElementById(`skill-item-${skill.id}`);
            if (!skillElement) return;

            const mainCircleIcon = skillElement.querySelector('.skill-main-circle i');
            const ringSegments = skillElement.querySelectorAll('.ring-segment');

            // Update main circle and icon
            if (skill.currentLevel > 0) {
                skillElement.classList.add('active');
                mainCircleIcon.className = skill.icon; // Set specific skill icon
            } else {
                skillElement.classList.remove('active');
                mainCircleIcon.className = 'fas fa-plus'; // Set '+' icon for level 0
            }

            // Update ring segments
            ringSegments.forEach((segment, index) => {
                // Get the segment index from the data attribute
                const segmentIndex = parseInt(segment.getAttribute('data-segment-index') || index);
                
                if (segmentIndex < skill.currentLevel) {
                    segment.classList.add('active');
                } else {
                    segment.classList.remove('active');
                }
            });
            
            updateSkillActionButtonsState(skill);
        }

        function updateSkillActionButtonsState(skill) {
            const skillElement = document.getElementById(`skill-item-${skill.id}`);
            if (!skillElement) return;

            const increaseButton = skillElement.querySelector('.increase-skill-button');
            const decreaseButton = skillElement.querySelector('.decrease-skill-button');
            
            decreaseButton.disabled = skill.currentLevel <= 0;

            const costForNextLevel = getCostForNextSkillLevel(skill);
            const availablePoints = currentMaxSkillPoints - currentUsedSkillPoints;

            if (skill.currentLevel >= skill.maxLevel || availablePoints < costForNextLevel) {
                increaseButton.disabled = true;
            } else {
                increaseButton.disabled = false;
            }
        }

        function updateAllSkillActionButtonsState() {
            for (const category in skillsConfiguration) {
                skillsConfiguration[category].forEach(skill => {
                    updateSkillActionButtonsState(skill);
                });
            }
        }

        function handleIncreaseSkillLevel(skillId) {
            const skill = getSkillObjectById(skillId);
            if (!skill || skill.currentLevel >= skill.maxLevel) return;

            const costToUpgrade = getCostForNextSkillLevel(skill);
            const availablePoints = currentMaxSkillPoints - currentUsedSkillPoints;

            if (availablePoints >= costToUpgrade) {
                skill.currentLevel++;
                updateSkillPointSummaryDisplays();
                renderSingleSkill(skill);
                
                // Auto-save horse after skill change
                autoSaveHorse();
            }
        }

        function handleDecreaseSkillLevel(skillId) {
            const skill = getSkillObjectById(skillId);
            if (!skill || skill.currentLevel <= 0) return;

            skill.currentLevel--;
            updateSkillPointSummaryDisplays();
            renderSingleSkill(skill);
            
            // Auto-save horse after skill change
            autoSaveHorse();
        }

        function handleMaxSkillPointsChange(event) {
            let newMaxValue = parseInt(event.target.value, 10);
            if (isNaN(newMaxValue) || newMaxValue < 0) {
                newMaxValue = 0;
                maxSkillPointsInputElement.value = 0;
            }
            currentMaxSkillPoints = newMaxValue;
            updateSkillPointSummaryDisplays();
            
            // Auto-save horse after max points change
            autoSaveHorse();
        }
        
        // Show the max points editor
        function showMaxPointsEditor() {
            // Hide the display, show the editor
            maxPointsDisplayElement.style.display = 'none';
            maxPointsEditorElement.style.display = 'inline-flex';
            
            // Set the input value to the current max points
            maxSkillPointsInputElement.value = currentMaxSkillPoints;
            
            // Focus and select the input text
            maxSkillPointsInputElement.focus();
            maxSkillPointsInputElement.select();
        }
        
        // Confirm max points edit
        function confirmMaxPointsEdit() {
            const newMaxValue = parseInt(maxSkillPointsInputElement.value, 10);
            if (!isNaN(newMaxValue) && newMaxValue >= 0) {
                // Update the max points value if valid
                const oldMaxValue = currentMaxSkillPoints;
                currentMaxSkillPoints = newMaxValue;
                
                // Update the display value
                maxPointsValueElement.textContent = newMaxValue;
                
                // Show toast if the value changed
                if (oldMaxValue !== newMaxValue) {
                    updateSkillPointSummaryDisplays();
                    showToast(`Max skill points updated to ${newMaxValue}!`, 'info');
                    
                    // Auto-save horse after max points change
                    autoSaveHorse();
                }
            }
            
            // Hide editor, show display
            hideMaxPointsEditor();
        }
        
        // Cancel max points edit
        function hideMaxPointsEditor() {
            maxPointsEditorElement.style.display = 'none';
            maxPointsDisplayElement.style.display = 'inline-flex';
        }
        
        function handleResetHorse() {
            if (confirm("Are you sure you want to reset this horse's skills to zero?")) {
                // Reset all skill levels to 0
                for (const category in skillsConfiguration) {
                    skillsConfiguration[category].forEach(skill => {
                        skill.currentLevel = 0;
                    });
                }
                
                // Don't reset the horse name or max points
                updateSkillPointSummaryDisplays();
                
                // Re-render all skills to reflect the reset state
                for (const category in skillsConfiguration) {
                    skillsConfiguration[category].forEach(skill => {
                        renderSingleSkill(skill);
                    });
                }
                
                // Auto-save horse after reset
                autoSaveHorse();
                
                // Show toast notification
                showToast(`All skills for "${currentHorseName}" have been reset!`, 'warning');
            }
        }

        // Helper function for SVG arc calculations
        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        // Generate a path for an arc segment
        function generateArcSegmentPath(cx, cy, innerRadius, outerRadius, startAngle, endAngle) {
            // Calculate the four points of the arc segment
            const startOuter = polarToCartesian(cx, cy, outerRadius, startAngle);
            const endOuter = polarToCartesian(cx, cy, outerRadius, endAngle);
            const startInner = polarToCartesian(cx, cy, innerRadius, startAngle);
            const endInner = polarToCartesian(cx, cy, innerRadius, endAngle);
            
            // Determine if we need to use the large-arc-flag (1 for angles > 180)
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
            
            // Create the SVG path string
            const path = [
                `M ${startOuter.x} ${startOuter.y}`, // Move to the starting point (outer edge)
                `A ${outerRadius} ${outerRadius} 0 ${largeArcFlag} 1 ${endOuter.x} ${endOuter.y}`, // Outer arc
                `L ${endInner.x} ${endInner.y}`, // Line to inner edge
                `A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${startInner.x} ${startInner.y}`, // Inner arc (reverse direction)
                `Z` // Close the path
            ].join(" ");
            
            return path;
        }

        function createSkillDisplayElement(skill) {
            const skillItemCard = document.createElement('div');
            skillItemCard.classList.add('skill-item-card');
            skillItemCard.id = `skill-item-${skill.id}`;

            // Create the skill visual area that will contain the ring and the main circle
            const skillVisualArea = document.createElement('div');
            skillVisualArea.classList.add('skill-visual-area');
            
            // Create the SVG for the ring
            const svgNS = "http://www.w3.org/2000/svg";
            const ringSvg = document.createElementNS(svgNS, "svg");
            ringSvg.setAttribute("viewBox", "0 0 100 100");
            ringSvg.classList.add("skill-level-ring-svg");
            
            // Calculate the angles for each segment (5 segments for maxLevel=5)
            const segmentCount = skill.maxLevel;
            const degreesPerSegment = 360 / segmentCount;
            const gapAngle = 2; // Small gap between segments in degrees
            
            // Create the ring segments
            for (let i = 0; i < segmentCount; i++) {
                const startAngle = i * degreesPerSegment + gapAngle/2;
                const endAngle = (i + 1) * degreesPerSegment - gapAngle/2;
                
                const segmentPath = document.createElementNS(svgNS, "path");
                segmentPath.classList.add("ring-segment");
                // Add a data attribute to easily identify which segment this is
                segmentPath.setAttribute("data-segment-index", i);
                segmentPath.setAttribute("d", generateArcSegmentPath(50, 50, 35, 45, startAngle, endAngle));
                
                // If the skill level is already above this segment, make it active
                if (i < skill.currentLevel) {
                    segmentPath.classList.add("active");
                }
                
                ringSvg.appendChild(segmentPath);
            }
            
            // Add the SVG to the visual area
            skillVisualArea.appendChild(ringSvg);
            
            // Create the main circle and add it to the visual area
            const mainCircle = document.createElement('div');
            mainCircle.classList.add('skill-main-circle');
            
            // Initial icon is '+' if level 0, otherwise the skill's icon
            const initialIconClass = skill.currentLevel > 0 ? skill.icon : 'fas fa-plus';
            mainCircle.innerHTML = `<i class="${initialIconClass}"></i>`;
            
            skillVisualArea.appendChild(mainCircle);
            
            // Add the visual area to the skill card
            skillItemCard.appendChild(skillVisualArea);
            
            // Add the rest of the skill card content
            const skillNameDiv = document.createElement('div');
            skillNameDiv.classList.add('skill-name-text');
            skillNameDiv.textContent = skill.name;
            skillItemCard.appendChild(skillNameDiv);
            
            const actionButtonsDiv = document.createElement('div');
            actionButtonsDiv.classList.add('skill-action-buttons');
            actionButtonsDiv.innerHTML = `
                <button class="decrease-skill-button" aria-label="Decrease ${skill.name} level">-</button>
                <button class="increase-skill-button" aria-label="Increase ${skill.name} level">+</button>
            `;
            skillItemCard.appendChild(actionButtonsDiv);
            
            const costInfoDiv = document.createElement('div');
            costInfoDiv.classList.add('skill-cost-info-text');
            skillItemCard.appendChild(costInfoDiv);
            
            // Set active class on the card if the skill level is > 0
            if (skill.currentLevel > 0) {
                skillItemCard.classList.add('active');
            }

            // Add event listeners for the buttons
            skillItemCard.querySelector('.increase-skill-button').addEventListener('click', () => handleIncreaseSkillLevel(skill.id));
            skillItemCard.querySelector('.decrease-skill-button').addEventListener('click', () => handleDecreaseSkillLevel(skill.id));
            
            return skillItemCard;
        }

        function initializeSkillPlanner() {
            for (const categoryKey in skillsConfiguration) {
                const categorySection = document.getElementById(`${categoryKey}-skills-category`);
                const skillsGrid = categorySection.querySelector('.skills-grid');
                
                if (skillsGrid) {
                    skillsConfiguration[categoryKey].forEach(skill => {
                        const skillElement = createSkillDisplayElement(skill);
                        skillsGrid.appendChild(skillElement);
                        renderSingleSkill(skill);
                    });
                } else {
                    console.error("Skills grid container not found for category:", categoryKey);
                }
            }
            maxSkillPointsInputElement.value = currentMaxSkillPoints;
            updateSkillPointSummaryDisplays();
        }

        // ------ EVENT LISTENERS ------
        
        // Handle sticky header effect
        function handleScroll() {
            const pointsSummary = document.querySelector('.points-summary-grid');
            const pointsSummaryPosition = pointsSummary.getBoundingClientRect().top;
            
            if (pointsSummaryPosition <= 0) {
                pointsSummary.classList.add('is-sticky');
            } else {
                pointsSummary.classList.remove('is-sticky');
            }
        }
        
        window.addEventListener('scroll', handleScroll);
        
        // Horse management buttons
        newHorseButton.addEventListener('click', showNewHorseModal);
        saveHorseButton.addEventListener('click', showSaveHorseModal);
        loadHorseButton.addEventListener('click', showLoadHorseModal);
        
        // Close modal button
        closeModalButton.addEventListener('click', closeModal);
        
        // Close modal when clicking outside
        horseManagementModal.addEventListener('click', (e) => {
            if (e.target === horseManagementModal) {
                closeModal();
            }
        });
        
        // Welcome popup event listeners
        const welcomePopup = document.getElementById('welcomePopup');
        const closeWelcomePopupBtn = document.getElementById('closeWelcomePopup');
        const welcomeGetStartedBtn = document.getElementById('welcomeGetStartedBtn');
        
        // Function to check if it's a first-time visitor
        function isFirstTimeVisitor() {
            return Object.keys(getSavedHorses()).length === 0 && !localStorage.getItem('welcomeShown');
        }
        
        // Function to show welcome popup
        function showWelcomePopup() {
            welcomePopup.style.display = 'flex';
            // Mark that the welcome popup has been shown
            localStorage.setItem('welcomeShown', 'true');
        }
        
        // Function to close welcome popup
        function closeWelcomePopup() {
            welcomePopup.style.display = 'none';
        }
        
        // Event listeners for welcome popup
        closeWelcomePopupBtn.addEventListener('click', closeWelcomePopup);
        welcomeGetStartedBtn.addEventListener('click', () => {
            closeWelcomePopup();
            // Create a new horse with a default name
            showNewHorseModal();
        });
        
        // Close welcome popup when clicking outside
        welcomePopup.addEventListener('click', (e) => {
            if (e.target === welcomePopup) {
                closeWelcomePopup();
            }
        });
        
        // Edit name button
        editNameButton.addEventListener('click', showNameEditor);
        
        // Max points editing
        maxPointsDisplayElement.addEventListener('click', showMaxPointsEditor);
        confirmMaxPointsButton.addEventListener('click', confirmMaxPointsEdit);
        cancelMaxPointsButton.addEventListener('click', hideMaxPointsEditor);
        maxSkillPointsInputElement.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                confirmMaxPointsEdit();
            } else if (e.key === 'Escape') {
                hideMaxPointsEditor();
            }
        });
        
        // Existing event listeners
        maxSkillPointsInputElement.addEventListener('change', handleMaxSkillPointsChange);
        maxSkillPointsInputElement.addEventListener('input', (event) => {
            if (event.target.value === "" || event.target.value === "-") return;
            handleMaxSkillPointsChange(event);
        });
        resetHorseButton.addEventListener('click', handleResetHorse);

        document.addEventListener('DOMContentLoaded', () => {
            initializeSkillPlanner();
            
            // Set initial max points display value
            maxPointsValueElement.textContent = currentMaxSkillPoints;
            
            // Try to load the last active horse if available
            const lastLoadedHorseId = getLastLoadedHorseId();
            const savedHorses = getSavedHorses();
            
            if (lastLoadedHorseId && savedHorses[lastLoadedHorseId]) {
                // Load the last active horse
                loadHorseState(savedHorses[lastLoadedHorseId]);
            } else {
                // Otherwise, load the most recently modified horse
                const horseIds = Object.keys(savedHorses);
                
                if (horseIds.length > 0) {
                    // Find the most recently modified horse
                    let mostRecentHorseId = horseIds[0];
                    let mostRecentDate = new Date(savedHorses[mostRecentHorseId].lastModified || 0);
                    
                    for (let i = 1; i < horseIds.length; i++) {
                        const horseDate = new Date(savedHorses[horseIds[i]].lastModified || 0);
                        if (horseDate > mostRecentDate) {
                            mostRecentDate = horseDate;
                            mostRecentHorseId = horseIds[i];
                        }
                    }
                    
                    // Load the most recent horse
                    loadHorseState(savedHorses[mostRecentHorseId]);
                }
            }
            
            // Check if it's a first-time visitor and show welcome popup if so
            if (isFirstTimeVisitor()) {
                // Slight delay to ensure page renders first
                setTimeout(showWelcomePopup, 500);
            }
            
            // Initialize the sticky effect
            handleScroll();
        });

        // ------ AUTO-SAVE FUNCTION ------
        
        // Auto-save horse without showing notification
        function autoSaveHorse() {
            if (currentHorseId) {
                const horses = getSavedHorses();
                const currentHorse = getCurrentHorseState();
                
                // Add or update horse in the collection
                horses[currentHorse.id] = currentHorse;
                
                // Save to local storage
                saveHorsesToStorage(horses);
                
                // Save as last loaded horse
                saveLastLoadedHorseId(currentHorse.id);
                
                return currentHorse;
            }
            return null;
        }
    </script>
</body>
</html>
